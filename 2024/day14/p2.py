import math
from collections import defaultdict
from itertools import groupby

from data.grid import as_grid, get_adjacent, print_grid, print_grid_from_coords
import re

GRID_WIDTH = 101
GRID_HEIGHT = 103


def move_for(bots):
    secs = 0
    best_match = 0
    while True:
        secs += 1
        rows = defaultdict(list)
        coords = []
        for bot in bots:
            pos = bot[0]
            vel = bot[1]

            pos[0] = (pos[0] + vel[0]) % GRID_WIDTH
            pos[1] = (pos[1] + vel[1]) % GRID_HEIGHT


            rows[pos[1]].append(pos[0])
            coords.append(pos)

        matched_rows = 0
        last_segment = None

        for key in sorted(rows.keys()):
            row = sorted(rows[key])
            row_segments = [list(group) for _, group in
                            groupby(row, key=lambda x, i=iter(range(len(row))): x - next(i))]
            max_segment = max(len(seg) for seg in row_segments)

            if last_segment is not None and max_segment == last_segment + 2:
                matched_rows += 1
                last_segment = max_segment
            else:
                matched_rows = 0
                last_segment = max_segment

            if matched_rows > best_match:
                best_match = matched_rows
                print_grid_from_coords(coords, GRID_WIDTH, GRID_HEIGHT)
                print(best_match, secs)



with open("day14.txt", 'r') as f:
    lines = f.read().splitlines()

    bots = []
    quads = {'TL': 0, 'TR': 0, 'BR': 0, 'BL': 0}
    for line in lines:

        parts = line.split(" ")
        pos = [int(x) for x in parts[0][2:].split(",")]
        vel = [int(x) for x in parts[1][2:].split(",")]

        bot = (pos, vel)
        bots.append(bot)
    total = move_for(bots)

    print(f"\nDay 14-2: {total}")


# ..................................#.#................................................................
# .....................................................................................................
# ...................................#..........................#......................................
# ...............#..............................................#..................................#...
# .....#.......................#..............................#........................................
# .....................................................................................................
# .....................................................................................................
# .....................................................................................................
# .............#.........................#.............................................................
# ........................................................#............................................
# .....................................................................................................
# .....................................................................................................
# ......................................................................................#..............
# ........................................................#.#..........................................
# ....................................#................................................................
# .....................................................................................................
# ....................................................................#................................
# .................#...................................................................................
# ....................................#...............###############################..................
# ..................#..................#............#.#.............................#..................
# .......#............................................#.............................#..##..............
# ....................................................#.............................#..................
# .......#........................#...................#.............................#..................
# ....................................................#..............#..............#..............#...
# .................#..................................#.............###.............#..................
# ........#...........................................#............#####............#...#..............
# ....................................................#...........#######...........#..................
# ....................................................#..........#########..........#...#..............
# ....................................................#............#####............#..................
# ....................................................#...........#######...........#.......#..........
# .....................#..............................#..........#########..........#.................#
# ....................................................#.........###########.........#..................
# ......#.............................................#........#############........#..................
# ............................................#.......#..........#########..........#..................
# ....................................................#.........###########.........#..................
# ....................................................#........#############........#..................
# ....................................................#.......###############.......#..................
# ....................................................#......#################......#..................
# ....................................................#........#############........#..................
# ....................................................#.......###############.......#..................
# ....................................................#......#################......#..................
# ...........#..........................#.............#.....###################.....#..................
# .......#...#........................................#....#####################....#..................
# ....................................................#.............###.............#..................
# .........#......................................#...#.............###.............#..................
# ...................................#................#.............###.............#..................
# ....................................................#.............................#.......#..........
# ......#...#.........................................#.............................#..................
# .....................#..............................#.............................#..................
# .............................#......................#.............................#..................
# .................................#.........#........###############################..................
# ............#....................................#..........................................#....#...
# .........#........#...........................................#......................#...............
# ...................................................#.#..............#................................
# .....................................................................................................
# ....#..............................................#..........................#......................
# ....................................#..............................#.................................
# ..................#..................................................................................
# ....#...............................................#..............#.................#...............
# ..#.#....................................#................#..........................................
# ................#..............#...............................#.....................................
# ......#..........#..............#.......................................#............................
# ......................................................#..............................................
# .................#............................................................#......................
# .....................................................................................................
# ..................................................................................#...#..............
# .....................................................................................................
# ....................#................................................................#...............
# .....................................................................................................
# .....................................................................................................
# ............#...........................................................................#............
# .....................................................................................................
# .......#...#.......................................................................#.................
# ........................................#.......................................................#....
# ...........#........#............#..................................................................#
# ................................................................................................#....
# ...............#...............................#.....................................................
# ..#......................................................#..................#.......................#
# .........#...........................................................................................
# #.....................#.........................................................................#....
# ...............................................................................#.....................
# .....................................................................................................
# ........................................................#..........................#.................
# .......................................#.............................................................
# .....................................................................................................
# #..................................#.................................................................
# .......................................................#.............................................
# .......................................#.....................#.......................................
# ..............#.#.....................................#......................................#.......
# .....................................................................................................
# .....................................................................................................
# ................................#....................................................................
# ......#..............................................................................................
# .......................#....#........................................................................
# ..........................#...................................................#...........#..........
# .......#...................................................#...................#.#...................
# .......................#.............................................................................
# ..........#...........................................#..............................................
# ...................................................................#.................................
# ......................................#............................#.................................
# ..........................................#............#....................#........................
# .....................................................................................................
# ...#.................................................................................................
